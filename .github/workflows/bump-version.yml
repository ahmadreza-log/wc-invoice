name: üî¢ Auto Bump Version

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
      - '.github/**'

jobs:
  bump-version:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'chore: bump version')"
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: üîß Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          tools: composer

      - name: üìù Get current version
        id: get_version
        run: |
          VERSION=$(grep -oP "Version:\s*\K[0-9]+\.[0-9]+\.[0-9]+" wc-invoice.php)
          echo "current_version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: üî¢ Bump version (patch)
        id: bump_version
        run: |
          CURRENT="${{ steps.get_version.outputs.current_version }}"
          IFS='.' read -ra ADDR <<< "$CURRENT"
          MAJOR=${ADDR[0]}
          MINOR=${ADDR[1]}
          PATCH=${ADDR[2]}
          
          PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: ‚úèÔ∏è Update version in plugin file
        run: |
          NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"
          sed -i "s/Version:\s*[0-9]\+\.[0-9]\+\.[0-9]\+/Version: $NEW_VERSION/" wc-invoice.php
          sed -i "s/define('WC_INVOICE_VERSION', '[0-9]\+\.[0-9]\+\.[0-9]\+');/define('WC_INVOICE_VERSION', '$NEW_VERSION');/" wc-invoice.php

      - name: üìù Update CHANGELOG.md
        run: |
          NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"
          DATE=$(date +%Y-%m-%d)
          
          # Create new changelog entry
          ENTRY="## [Unreleased]\n\n## [$NEW_VERSION] - $DATE\n\n### Changed\n- üî¢ Auto-bumped version to $NEW_VERSION\n\n"
          
          # Insert after [Unreleased] section
          sed -i "/## \[Unreleased\]/a\\$ENTRY" CHANGELOG.md

      - name: üíæ Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add wc-invoice.php CHANGELOG.md
          git commit -m "chore: bump version to ${{ steps.bump_version.outputs.new_version }}" || exit 0
          git push

      - name: üè∑Ô∏è Create git tag
        run: |
          NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"
          git tag -a "v$NEW_VERSION" -m "Version $NEW_VERSION"
          git push origin "v$NEW_VERSION"

